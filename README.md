# Custom-Detection-Rule

---

## Scenario: Suspected Malware Infiltration in a Financial Institution

A large financial institution has a hybrid cloud infrastructure with critical workloads hosted in Azure. As part of the organization's cybersecurity strategy, they have implemented Microsoft Defender for Endpoint (EDR) to protect their endpoints and Microsoft Sentinel for centralized threat detection and analysis. Recently, an employee in the Finance Department reported unusual activity on their endpoint, including the appearance of a suspicious PowerShell script running background tasks.
Objective:
The organization's security team has decided to simulate a malware attack (EICAR test file) to evaluate the effectiveness of Microsoft Defender for Endpoint and Sentinel in detecting and responding to such threats. 

## Objectives
- Create and implement a custom detection rule in Microsoft Sentinel to detect specific PowerShell commands such as "Execution PolicyBypass  and Invoke-WebRequest.
- Confirm that Defender for Endpoint successfully detects the suspicious activity.
- Verify that Sentinel collects and correlates the logs to generate actionable alerts.
---

### **Tools and Resources**  
- **Azure Virtual Machine** (Windows Server or Windows 10/11)  
- **Microsoft Defender for Endpoint (EDR)** enabled and configured  
- **Microsoft Sentinel** for log aggregation and analysis  
- **EICAR Test File** (Safe and harmless malware simulation)  

---

### **Step 1: Prepare the Environment**  
1. **Set Up an Azure Virtual Machine (VM):**
   - Launch an Azure VM with Windows OS.
   - Ensure the VM has proper network security group (NSG) rules for remote access.  

2. **Enable Microsoft Defender for Endpoint (EDR):**
   - Install and configure the Defender agent on the VM.
   - Verify that real-time protection is active.

3. **Integrate the VM with Microsoft Sentinel:**
   - Connect Defender to Microsoft Sentinel using the **Log Analytics Workspace** for centralized log collection and monitoring.


### **Step 2: Simulate the Malware Incident**  
1. **Download the EICAR Test File**:  
   - Run the following command in PowerShell to safely simulate a malware attack:  
     ```powershell
     powershell.exe -ExecutionPolicy Bypass -Command Invoke-WebRequest -Uri https://secure.eicar.org/eicar.com.txt -OutFile C:\test\eicar.com
     ```
     _Note: The EICAR test file is specifically designed for antivirus testing and poses no actual harm._

2. **Trigger Detection**:  
   - Attempt to execute the EICAR file on the VM. Defender for Endpoint (EDR) should detect and block the file.

3. **Monitor Alerts**:  
   - Log into Microsoft Sentinel.
   - Query logs and review alerts triggered by the Defender for Endpoint agent.

---

### **Step 3: Investigate the Incident**  
1. **Analyze the Alert in Microsoft Sentinel**:  
   - Use **KQL queries** to locate and analyze logs related to the alert.
   - Example query:  
     ```kql
     SecurityAlert
     | where AlertName == "Malware detected in file"
     | project AlertName, TimeGenerated, Description, EntityDetails
     ```

2. **Review Endpoint Activity in Defender (EDR)**:  
   - Investigate the process tree to understand how the file was executed and whether it interacted with other system components.  
   - Examine disk and memory operations logged by the EDR agent.

3. **Assess the Impact**:  
   - Determine if the test file attempted lateral movement or caused further system changes.
   - Check network logs in Sentinel for suspicious traffic generated by the file.

---

### **Step 4: Contain and Resolve the Incident**  
1. **Contain the Threat**:  
   - Verify that Defender for Endpoint automatically quarantined the EICAR test file.  
   - Check system logs to ensure no additional files were affected.

2. **Perform Remediation**:  
   - Delete the EICAR test file from the system.  
   - Run a full system scan using the Defender agent to ensure the endpoint is clean.

3. **Document Actions Taken**:  
   - Note the remediation steps, including log review and manual deletion of the file.

---

### **Step 5: Review and Report**  
1. **Create a Post-Incident Summary Report**:  
   - Document the process, including:
     - **Detection**: Alerts generated by Defender and logs in Sentinel.
     - **Investigation**: Process tree analysis and log details.
     - **Remediation**: Actions taken to resolve the issue.  

2. **Publish the Documentation**:  
   - Format the report for professional sharing, emphasizing the practical use of Sentinel and EDR for threat hunting and incident response.

---

### **Final Notes**  
By relying on Microsoft Sentinel and Microsoft Defender for Endpoint (EDR), this simulation showcases effective detection, investigation, and remediation workflows in the absence of Microsoft 365 Defender. Regular incident simulations help strengthen your technical capabilities and prepare for real-world scenarios.

---

Let me know if you'd like any other sections refined further! ðŸš€
